#!/bin/bash

# reencode all files in the dir

usage() {
    local err=$1
    local msg=$2

    if [[ -n "$msg" ]] ; then
        echo "ERROR: $msg"
        echo
    fi

    echo "$0 [-h] [-d] [-s]"
    echo
    echo "-h  help"
    echo "-d  dryrun"
    echo "-s  slower"
    echo

    exit $err
}

DRYRUN=""
while getopts "dsh" opt ; do
    case $opt in
        d)  DRYRUN="echo"
            ;;
        s)  ;;
        h)  usage
            ;;
    esac
done

START=$(du -c . | tail -n1 | cut -f 1)

echo "" > remove

for infile in * ; do
    case "$infile" in
        *reencode*) ;;
        *.avi | *.mkv | *.mp4)
            reencode-file $@ -f "$infile"
            ;;
    esac
done && \
$DRYRUN rm -f *.nfo && \
$DRYRUN rm -rf '.@__thumb' && \
for x in * ; do
    case "$x" in
        *reencode*) ;;
        *.mkv | *.avi | *.mp4)
            echo "\rm -f \"${x}\"" | grep -v reencode >> remove
            ;;
    esac
done

echo "\rm -f remove" >> remove

END=$(du -c . | tail -n1 | cut -f 1)

echo -n "reencode size percent: "
echo "(${END}-${START}) / ${START}" | bc -l
