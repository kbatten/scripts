#!/bin/bash

# reencode all subdirs

usage() {
    local err=$1
    local msg=$2

    if [[ -n "$msg" ]] ; then
        echo "ERROR: $msg"
        echo
    fi

    echo "$0 [-h] [-d] [-s]"
    echo
    echo "-h  help"
    echo "-d  dryrun"
    echo "-s  slower"
    echo

    exit $err
}

DRYRUN=""
while getopts "dsh" opt ; do
    case $opt in
        d)  DRYRUN="echo"
            ;;
        s)  ;;
        h)  usage
            ;;
    esac
done

START=$(du -c . | tail -n1 | cut -f 1)

echo "" > remove

for indir in */; do
    pushd "$indir"
    reencode $@
    echo "cd \"$indir\"" >> ../remove
    cat remove >> ../remove
    echo "cd .." >> ../remove
    rm -f remove
    popd
done && \
$DRYRUN rm -f *.nfo && \
$DRYRUN rm -rf '.@__thumb' && \

echo "\rm -f remove" >> remove

END=$(du -c . | tail -n1 | cut -f 1)

echo -n "reencode-dirs size percent: "
echo "(${END}-${START}) / ${START}" | bc -l
