#!/bin/bash

# reencode a single file

usage() {
    local err=$1
    local msg=$2

    if [[ -n "$msg" ]] ; then
        echo "ERROR: $msg"
        echo
    fi

    echo "$0 [-h] [-d] [-p <veryslow | slower | slow | medium | (fast) | faster | superfast | ultrafast>] [-7] <-f filename>"
    echo
    echo "-h  help"
    echo "-d  dryrun"
    echo "-p  preset"
    echo "-7  reencode to 720p"
    echo "-f  filename"
    echo

    exit $err
}


DRYRUN=""
SPEED="fast"
FILTER=""
while getopts "dp:7f:h" opt ; do
    case $opt in
        d)  DRYRUN="echo"
            ;;
        s)  SPEED="${OPTARG}"
            ;;
        7)  FILTER="-filter:v scale=720:-1"
            ;;
        f)  FILENAME="${OPTARG}"
            ;;
        h)  usage
            ;;
    esac
done

if [[ -z "$FILENAME" ]] ; then
    usage 1 "missing filename"
fi

di_opts=""
qual_opts="-crf 21"
codec="libx265"
speed="$SPEED"

infile="$FILENAME"
outfile="${infile}-reencodex265.mkv"

START=$(du -c "$infile" | tail -n1 | cut -f 1)

$DRYRUN ffmpeg -i "${infile}" ${FILTER} ${di_opts} ${qual_opts}  -c:v ${codec} -sn -c:a aac ${subtitle} -preset ${speed} "${outfile}"

END=$(du -c "$outfile" | tail -n1 | cut -f 1)

echo -n "reencode-file size percent: "
echo "(${START}-${END}) / ${START}" | bc -l
