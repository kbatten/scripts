#!/bin/bash -e

source ./script_lib/std.inc
source ./script_lib/install.inc
source ./script_lib/link.inc

FROM_SOURCE=1

if [[ $FROM_SOURCE -eq 0 ]] ; then
    sudo apt-get install -y ffmpeg
else
    sudo apt-get install -y nasm pkg-config libx264-dev libx265-dev build-essential libvidstab-dev libssl-dev libopus-dev libaom-dev

    download_github git@github.com:FFmpeg/FFmpeg.git
    pushd "${TANQ_DOWNLOAD_DIR}/FFmpeg"

    export PKG_CONFIG_PATH=/usr/lib/x86_64-linux-gnu/pkgconfig/:$PKG_CONFIG_PATH
    ./configure --enable-gpl --enable-libx264 --enable-libx265 --enable-libvidstab --enable-openssl --enable-version3 --enable-libopus --enable-libaom --prefix="$HOME/opt/ffmpeg"
    make
    make install
    popd

    link_bin_external "$HOME/opt/ffmpeg/bin/ffmpeg"
    link_bin_external "$HOME/opt/ffmpeg/bin/ffprobe"

    install_rust

    download_github git@github.com:ImageOptim/gifski.git
    pushd "${TANQ_DOWNLOAD_DIR}/gifski"
    cargo build --release
    if [[ -e "$HOME/opt/gifski" ]] ; then
        rm -rf "$HOME/opt/gifski"
    fi
    cp -r "target/release" "$HOME/opt/gifski"
    popd

    link_bin_external "$HOME/opt/gifski/gifski"
fi

echo "finished $0"
